{% extends 'default/index.html.twig' %}

{% block content_header %}
    <h1>Transfert de fonds</h1>
{% endblock %}

{% block content %}
    {% if beginDate is not null %}
        <div class="row">
            <div class="col-sm-3">
                {% include 'tontineBundle:TransfertFonds:partials/form.html.twig' with { submit: 'Valider' } %}
            </div>
            <div class="col-sm-9">
                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title">Etats des depots de mise</h3>
                    </div>
                    <div class="box-body" id="etat-transfert">
                    </div>
                </div>
            </div>
        </div>        
    {% else %}
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title">Transfert de fonds</h3>
            </div>
            <div class="box-body">
                <p class="text-center">
                    Vous ne pouvez pas transférer de fonds actuellement. Aucun depot n'a été effectué !
                </p>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script type="text/javascript">
        $(function() {
            $('#tontinebundle_transfertfonds_pieceFile').closest('.form-group').hide();

            $('#transfer-fonds-from').on('submit', function(event) {
                var $submitBtn = $(this).find('#btn-submit')
                if ($submitBtn.hasClass('ajax')) {
                    event.preventDefault();
                    $submitBtn.prepend('<i class="fa fa-spinner fa-spin"></i>');
                    $submitBtn.attr('disabled', true);                    
                } else if ($('#tontinebundle_transfertfonds_pieceFile').val() == '') {
                    event.preventDefault();
                    alert('Veuillez joindre la piece justificative');
                    return;
                }

                $.ajax({
                    url: '{{ path("tontine_transfert_fonds_etat") }}',
                    type: 'POST',
                    data: $(this).serialize(),
                    dataType: 'json'
                })
                .done(function (response) {
                    $submitBtn.attr('disabled', false);
                    $submitBtn.text('Transférer les fonds')
                    $submitBtn.removeClass('ajax');
                    
                    console.log(response);
                    $('#tontinebundle_transfertfonds_montant').val(response.amount);
                    $('#tontinebundle_transfertfonds_pieceFile').closest('.form-group').fadeIn();
                    $('#amount').text(response.amount + ' FCFA');
                    {#$('#amount-block').fadeIn();#}
                    $('#etat-transfert').html(response.table);
                })
                .fail(function (error) {
                    $submitBtn.attr('disabled', false);
                    $submitBtn.text('Valider');
                    console.log(error.responseText);
                })
            })
        })
    </script>
{% endblock %}